## 38. 数据映射

### QDataWidgetMapper

QDataWidgetMapper可以用于通过将**数据感知小部件映射到项目模型的部分**来创建它们。如果方向为水平（默认值），则剖面是**模型的一列，否则为一行**。
每次当前索引更改时，每个小部件都会通过映射时指定的属性，使用模型中的数据进行更新。如果用户编辑小部件的内容，则使用相同的属性读取更改并将其写回模型。默认情况下，每个小部件的用户属性用于在模型和小部件之间传输数据。自从Qt 4.3以来，一个额外的addMapping()函数可以使用一个命名属性，而不是默认的用户属性。
可以将项目委托设置为支持自定义小部件。默认情况下，QItemDelegate用于将模型与小部件同步。
让我们假设我们有一个名为model的项目模型，其内容如下：

|     Key      |   Value   |
| :----------: | :-------: |
|  Qt Norway   |   Oslo    |
| Qt Australia | Brisbane  |
|    Qt USA    | Palo Alto |
|   Qt China   |  Beijing  |
|  Qt Germany  |  Berlin   |

以下代码将模型的列映射到名为mySpinBox、myLineEdit和myCountryChooser的小部件：

```c++
  QDataWidgetMapper *mapper = new QDataWidgetMapper;
  mapper->setModel(model);
  mapper->addMapping(mySpinBox, 0);
  mapper->addMapping(myLineEdit, 1);
  mapper->addMapping(myCountryChooser, 2);
  mapper->toFirst();
```

调用toFirst()后，mySpinBox显示值1，myLineEdit显示Qt Norway，myCountryChooser显示Oslo。toFirst()、toNext()、toPrevious()、toLast()和setCurrentIndex()可用于在模型中导航，并使用模型中的内容更新小部件。setRootIndex()函数允许将模型中的特定项指定为根索引-该项的子项将映射到用户界面中的相关小部件。
QDataWidgetMapper支持两种提交策略，AutoSubmit和ManualSubmit。AutoSubmit会在当前小部件失去焦点后立即更新模型，ManualSubmit不会更新模型，除非调用submit()。当显示允许用户取消所有修改的对话框时，ManualSubmit非常有用。此外，在用户完成所有修改并提交之前，显示模型的其他视图不会更新。
请注意，QDataWidgetMapper会跟踪外部修改。如果模型的内容在应用程序的另一个模块中更新，那么小部件也会更新。

此枚举描述QDataWidgetMapper支持的可能提交策略。

```c++
enum QDataWidgetMapper::SubmitPolicy{
    QDataWidgetMapper::AutoSubmit
    QDataWidgetMapper::ManualSubmit
}
void setSubmitPolicy(QDataWidgetMapper::SubmitPolicy policy);
QDataWidgetMapper::SubmitPolicy submitPolicy() const;

void addMapping(QWidget *widget, int section);
void addMapping(QWidget *widget, int section, const QByteArray &propertyName);
void clearMapping();
void removeMapping(QWidget *widget);

int currentIndex() const;
int mappedSection(QWidget *widget) const;
Qt::Orientation orientation() const;
QAbstractItemDelegate *itemDelegate() const;
QByteArray mappedPropertyName(QWidget *widget) const;
QWidget *mappedWidgetAt(int section) const;
QAbstractItemModel *model() const;
QModelIndex rootIndex() const;

void setItemDelegate(QAbstractItemDelegate *delegate);
void setModel(QAbstractItemModel *model);
void setOrientation(Qt::Orientation aOrientation);
void setRootIndex(const QModelIndex &index);
```

